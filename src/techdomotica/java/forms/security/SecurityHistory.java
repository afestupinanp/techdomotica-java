package techdomotica.java.forms.security;

import java.awt.Component;
import java.util.ArrayList;
import javax.swing.ImageIcon;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;

import techdomotica.objs.Ambiente;
import techdomotica.objs.Conectar;
import techdomotica.objs.Reporte;
import techdomotica.objs.Util;

/**
 *
 * @author Andres
 */
public class SecurityHistory extends javax.swing.JFrame {

    //private final java.awt.Font segoe = techdomotica.objs.Util.cargarFuente(this, "/resources/fonts/Roboto-Regular.ttf");
    
    private Ambiente ambiente;
    private Conectar conx;
    
    private ArrayList<Reporte> reportes = new ArrayList();
    private int selectedRow = 0;

    public SecurityHistory(Ambiente amb) {
        ambiente = amb;
        conx = amb.getConnection();
        initComponents();
        
        loadTable();
        setIconImage(new ImageIcon(getClass().getResource("/resources/media/L4.png")).getImage());
        setLocationRelativeTo(null);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel2 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        tableReports = new javax.swing.JTable() {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        jLabel3 = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        labelTypeReport = new javax.swing.JLabel();
        labelUserReport = new javax.swing.JLabel();
        labelReportDateTime = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        reportMainText = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jScrollPane2 = new javax.swing.JScrollPane();
        txtReport = new javax.swing.JTextArea();
        jButton1 = new javax.swing.JButton();
        charRemaining = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Historial de reportes - Tech Domótica");
        setResizable(false);

        jPanel1.setPreferredSize(new java.awt.Dimension(370, 79));

        jLabel2.setText("Haz doble click a un reporte para ver en detalle.");

        tableReports.setAutoCreateRowSorter(true);
        tableReports.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {},
                {},
                {},
                {}
            },
            new String [] {

            }
        ));
        tableReports.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tableReportsMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(tableReports);

        jLabel3.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel3.setText("Historial de reportes");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                    .addComponent(jLabel2, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 350, Short.MAX_VALUE)
                    .addComponent(jLabel3, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, 37, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 373, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jPanel2.setPreferredSize(new java.awt.Dimension(340, 0));

        jLabel1.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N
        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel1.setText("Reporte");

        labelTypeReport.setText("Tipo de reporte: -");

        labelUserReport.setText("Generado por: -");

        labelReportDateTime.setText("Fecha y hora de reporte: -");

        jLabel5.setText("Reporte:");

        reportMainText.setVerticalAlignment(javax.swing.SwingConstants.TOP);

        jLabel4.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N
        jLabel4.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel4.setText("Añadir un reporte");

        txtReport.setColumns(20);
        txtReport.setFont(new java.awt.Font("Tahoma", 0, 13)); // NOI18N
        txtReport.setLineWrap(true);
        txtReport.setRows(5);
        txtReport.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txtReportKeyPressed(evt);
            }
        });
        jScrollPane2.setViewportView(txtReport);

        jButton1.setText("Añadir reporte");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        charRemaining.setText("Caracteres restantes: 1000.");

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(reportMainText, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(labelReportDateTime, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(labelTypeReport, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(labelUserReport, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel5, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel4, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 330, Short.MAX_VALUE)
                    .addComponent(jScrollPane2)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel2Layout.createSequentialGroup()
                        .addComponent(charRemaining)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jButton1)))
                .addContainerGap())
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 37, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(labelTypeReport)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(labelUserReport)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(labelReportDateTime)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel5)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(reportMainText, javax.swing.GroupLayout.PREFERRED_SIZE, 123, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jLabel4, javax.swing.GroupLayout.PREFERRED_SIZE, 37, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 113, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jButton1)
                    .addComponent(charRemaining))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, 350, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, 469, Short.MAX_VALUE)
            .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, 469, Short.MAX_VALUE)
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void tableReportsMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tableReportsMouseClicked
        if(evt.getClickCount() == 2 && selectedRow == tableReports.getSelectedRow()) {
            makeReport();
        }
        else {
            selectedRow = tableReports.getSelectedRow();
        }
    }//GEN-LAST:event_tableReportsMouseClicked

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        if(!txtReport.getText().isEmpty()) {
            if(Reporte.insertReport(Integer.parseInt(ambiente.getAdminEncargado().getID()), 8, txtReport.getText()) == 1) {
                JOptionPane.showMessageDialog(null, "Se ha guardado el reporte de manera exitosa.", "Éxito en la operación", JOptionPane.INFORMATION_MESSAGE);
                txtReport.setText("");
                txtReport.requestFocus();
                loadTable();
            }
            else JOptionPane.showMessageDialog(null, "Ha ocurrido al momento de guardar el reporte. Intentalo más tarde.", "Error en la operación", JOptionPane.ERROR_MESSAGE);
        }
        else JOptionPane.showMessageDialog(null, "No puedes enviar un reporte vacío.", "Error", JOptionPane.ERROR_MESSAGE);
    }//GEN-LAST:event_jButton1ActionPerformed

    private void txtReportKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtReportKeyPressed
        String currentText = txtReport.getText();
        if(currentText.length() > 1001) {
            txtReport.setText(currentText);
        }
        charRemaining.setText(String.format("Caracteres restantes: %d", (1000 - currentText.length())));
    }//GEN-LAST:event_txtReportKeyPressed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(SecurityHistory.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(SecurityHistory.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(SecurityHistory.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(SecurityHistory.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new SecurityHistory(null).setVisible(true);
            }
        });
    }

    private void makeReport() {
        labelTypeReport.setText(String.format("Tipo de reporte: %s", reportes.get(selectedRow).getReportTypeString()));
        labelReportDateTime.setText(String.format("Fecha y hora de reporte: %s %s", reportes.get(selectedRow).getReportDate(), reportes.get(selectedRow).getReportHour()));
        labelUserReport.setText(String.format("Generado por: %s", tableReports.getValueAt(selectedRow, 1)));
        reportMainText.setText("<html>" + reportes.get(selectedRow).getReportText() + "</html>");
    }
    
    private void loadTable() {
        DefaultTableModel model = new DefaultTableModel();
        model.addColumn("#");
        model.addColumn("Usuario (cédula)");
        model.addColumn("Tipo de reporte");
        model.addColumn("Fecha");
        model.addColumn("Hora (24hr)");
        model.addColumn("Texto");
        
        if(conx.executeRS("SELECT reporte.id_usuario, reporte.id_tr, usuario.nom1, usuario.dni, reporte.id_reporte, tipo_reporte.nombre, reporte.fecha, reporte.hora, reporte.texto FROM reporte INNER JOIN tipo_reporte ON tipo_reporte.id_tr = reporte.id_tr INNER JOIN usuario ON reporte.id_usuario = usuario.id_usuario WHERE 1;")) {
            tableReports.getTableHeader().setReorderingAllowed(false);            
            reportes.clear();
            while(conx.nextRow()) {
                //Esto no es bonito, pero aquí voy... :v
                Reporte user = new Reporte(Integer.parseInt(String.valueOf(conx.getResultSetRow("id_reporte"))), Integer.parseInt(String.valueOf(conx.getResultSetRow("id_usuario"))), Integer.parseInt(String.valueOf(conx.getResultSetRow("id_tr"))), String.valueOf(conx.getResultSetRow("texto")).replaceAll("<br>", "\n"), String.valueOf(conx.getResultSetRow("nombre")), String.valueOf(conx.getResultSetRow("fecha")), String.valueOf(conx.getResultSetRow("hora")));
                reportes.add(user);
                Object[] fila = {conx.getResultSetRow("id_reporte"), conx.getResultSetRow("nom1") + "(" + conx.getResultSetRow("dni") + ")", conx.getResultSetRow("nombre"), conx.getResultSetRow("fecha"), conx.getResultSetRow("hora"), String.valueOf(conx.getResultSetRow("texto")).replaceAll("<br>", "\n")};
                model.addRow(fila);
            }
            
        }
        else {
            Object[] lol = {"No hay datos"};
            model.addRow(lol);
        }
        tableReports.setRowSelectionInterval(0, 0);
        selectedRow = 0;
        tableReports.setModel(model);
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel charRemaining;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JLabel labelReportDateTime;
    private javax.swing.JLabel labelTypeReport;
    private javax.swing.JLabel labelUserReport;
    private javax.swing.JLabel reportMainText;
    private javax.swing.JTable tableReports;
    private javax.swing.JTextArea txtReport;
    // End of variables declaration//GEN-END:variables
}
